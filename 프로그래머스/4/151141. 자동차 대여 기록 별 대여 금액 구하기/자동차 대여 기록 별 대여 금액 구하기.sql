-- 코드를 입력하세요
WITH TRUCK_PRICE_INFO AS (
    SELECT DURATION_TYPE, DISCOUNT_RATE
    FROM CAR_RENTAL_COMPANY_DISCOUNT_PLAN
    WHERE CAR_TYPE = '트럭'
)
SELECT  B.HISTORY_ID,
        FLOOR(((A.DAILY_FEE) - ((A.DAILY_FEE) * 
                 IFNULL((SELECT DISCOUNT_RATE
                         FROM TRUCK_PRICE_INFO 
                         WHERE DURATION_TYPE = B.DURATION_TYPE), 0) / 100)) * B.DURATION) AS FEE
FROM CAR_RENTAL_COMPANY_CAR A, (
    SELECT  HISTORY_ID, CAR_ID,
            (DATEDIFF(END_DATE, START_DATE) + 1) AS 'DURATION',
            CASE
                WHEN (DATEDIFF(END_DATE, START_DATE) + 1) >= 90 THEN '90일 이상'
                WHEN (DATEDIFF(END_DATE, START_DATE) + 1) >= 30 THEN '30일 이상'
                WHEN (DATEDIFF(END_DATE, START_DATE) + 1) >= 7 THEN '7일 이상'
                ELSE ''
            END AS 'DURATION_TYPE' 
    FROM CAR_RENTAL_COMPANY_RENTAL_HISTORY ) B
WHERE A.CAR_ID = B.CAR_ID
AND A.CAR_TYPE = '트럭'
ORDER BY FEE DESC, B.HISTORY_ID DESC;